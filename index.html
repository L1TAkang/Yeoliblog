<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yeoli Blog</title>
    
    <!-- Tailwind CSS CDN 불러오기 -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Pretendard 폰트 CDN 불러오기 -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <!-- Noto Serif KR 폰트 (Google Fonts) 불러오기 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Pretendard', sans-serif; }
        .font-noto-serif { font-family: 'Noto Serif KR', serif; }
        aside::-webkit-scrollbar { display: none; }
        aside { -ms-overflow-style: none; scrollbar-width: none; }
        main::-webkit-scrollbar { width: 5px; }
        main::-webkit-scrollbar-track { background: transparent; }
        main::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
        main::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
        .editor-content:focus { outline: none; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
        #aside-menu { transition: transform 0.3s ease-in-out; }
        .banner-image { width: 100%; height: 300px; object-fit: cover; }

        /* 편집기와 본문의 공통 스타일 */
        .content-body, .editor-content {
            font-size: 18px; /* 기본 폰트 크기를 18px로 고정 */
            line-height: 1.6;
        }
        .content-body h2, .content-body h3, .content-body h4,
        .editor-content h2, .editor-content h3, .editor-content h4 {
            font-weight: 700;
            line-height: 1.3;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .content-body h2, .editor-content h2 { font-size: 1.875rem; }
        .content-body h3, .editor-content h3 { font-size: 1.5rem; }
        .content-body h4, .editor-content h4 { font-size: 1.25rem; }
        
        .content-body p, .editor-content p {
            margin-top: 1.25em;
            margin-bottom: 1.25em;
        }
        
        .content-body blockquote, .editor-content blockquote {
            border-left: 4px solid #1f2937;
            padding-left: 1rem;
            margin: 1.5rem 0;
            font-style: italic;
            color: #4b5563;
        }

        .content-body hr, .editor-content hr {
            border-top: 1px solid #e5e7eb;
            margin: 2rem 0;
        }
        
        .content-body ul, .editor-content ul {
            list-style-type: disc;
            padding-left: 2rem;
            margin: 1.25em 0;
        }

        /* 코드 블록 스타일 */
        .code-block-wrapper {
            position: relative;
            background-color: #f3f4f6;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1.5rem 0;
            font-family: monospace;
        }
        .code-block-wrapper pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px; /* 코드 블록 최대 높이 (약 3cm) */
            overflow-y: auto; /* 내용이 길면 스크롤 생성 */
            scrollbar-width: thin;
            scrollbar-color: #d1d5db #f3f4f6;
        }
        .code-block-wrapper pre::-webkit-scrollbar { width: 8px; }
        .code-block-wrapper pre::-webkit-scrollbar-track { background: #f3f4f6; }
        .code-block-wrapper pre::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }
        .copy-code-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #d1d5db;
            color: #1f2937;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .code-block-wrapper:hover .copy-code-btn {
            opacity: 1;
        }


        /* 툴바 스타일 */
        .toolbar-btn {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .toolbar-btn:hover { background-color: #e5e7eb; }
        .toolbar-btn.active { background-color: #d1d5db; }
        .toolbar-select {
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            padding: 0.1rem 0.25rem;
            font-size: 0.875rem;
        }
        .color-swatch {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-white text-gray-800 overflow-hidden">

    <!-- 1. 헤더 -->
    <header class="fixed top-0 left-0 w-full h-16 bg-black flex items-center justify-between px-4 md:px-6 z-20">
        <div class="flex items-center">
            <button id="mobile-menu-btn" class="text-white mr-4 md:hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            <h1 class="text-2xl md:text-3xl font-bold text-white tracking-wider font-noto-serif">Yeoli Blog</h1>
        </div>
        <!-- 관리자 버튼 영역 -->
        <div id="admin-controls">
            <!-- 로그인/로그아웃/에디터 열기 버튼이 여기에 동적으로 추가됩니다. -->
        </div>
    </header>
    
    <div id="mobile-menu-overlay" class="hidden fixed inset-0 bg-black/50 z-30 md:hidden"></div>

    <!-- 2. 메인 컨테이너 -->
    <div id="main-container" class="flex pt-16 h-screen">
        <!-- 동적으로 컨텐츠가 렌더링될 영역 -->
    </div>
    
    <!-- 4. 게시물 편집기 모달 -->
    <div id="editor-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-bold">게시물 편집기</h2>
                <button id="editor-close-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <div class="flex-grow flex flex-col md:flex-row min-h-0">
                <div class="w-full md:w-1/3 lg:w-1/4 border-b md:border-b-0 md:border-r flex flex-col bg-gray-50">
                    <div id="editor-post-list" class="flex-grow overflow-y-auto p-4"></div>
                    <div class="p-4 border-t">
                        <button id="add-new-post-btn" class="w-full flex items-center justify-center px-4 py-2 bg-black text-white rounded-md">
                            <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                            새 게시물 추가
                        </button>
                    </div>
                </div>
                <div class="w-full md:w-2/3 lg:w-3/4 flex flex-col p-4 overflow-y-auto">
                    <div class="mb-4">
                        <label for="editor-title" class="block text-sm font-medium text-gray-700">제목</label>
                        <input type="text" id="editor-title" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 text-lg" placeholder="제목을 입력하세요">
                    </div>
                    <div class="mb-4 flex space-x-4">
                        <button id="add-banner-btn" class="text-sm text-gray-500 hover:text-black flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            배너 추가/수정
                        </button>
                        <button id="remove-banner-btn" class="text-sm text-red-500 hover:text-red-700 flex items-center disabled:opacity-50 disabled:cursor-not-allowed">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            배너 삭제
                        </button>
                    </div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4">
                        <div class="mb-4 sm:mb-0">
                            <label for="editor-date" class="block text-sm font-medium text-gray-700">발행일</label>
                            <input type="date" id="editor-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div class="flex items-center pt-6">
                            <input id="editor-pin-toggle" type="checkbox" class="h-4 w-4 text-black border-gray-300 rounded">
                            <label for="editor-pin-toggle" class="ml-2 text-sm">게시물 고정</label>
                        </div>
                    </div>
                    <div class="flex-grow flex flex-col">
                        <div id="editor-toolbar" class="flex items-center space-x-2 p-2 border border-b-0 border-gray-300 bg-gray-50 rounded-t-md flex-wrap">
                            <select id="font-family-select" class="toolbar-select">
                                <option value="Pretendard, sans-serif">Pretendard</option>
                                <option value="Noto Serif KR, serif">Noto Serif KR</option>
                            </select>
                            <button data-command="setGlobalFontSize" data-value="16px" class="toolbar-btn">작게</button>
                            <button data-command="setGlobalFontSize" data-value="18px" class="toolbar-btn">기본</button>
                            <button data-command="setGlobalFontSize" data-value="20px" class="toolbar-btn">크게</button>
                            <div class="relative">
                                <button id="color-picker-btn" class="toolbar-btn flex flex-col items-center justify-center">
                                    <span class="font-bold text-lg">A</span>
                                    <span id="current-color-display" class="block h-1 w-4 rounded" style="background-color: #000000;"></span>
                                </button>
                                <div id="color-dropdown" class="hidden absolute top-full left-0 bg-white border border-gray-200 rounded shadow-lg p-2 z-10">
                                    <div class="grid grid-cols-5 gap-1">
                                        <div class="color-swatch" style="background-color: #000000;" data-color="#000000"></div>
                                        <div class="color-swatch" style="background-color: #808080;" data-color="#808080"></div>
                                        <div class="color-swatch" style="background-color: #800000;" data-color="#800000"></div>
                                        <div class="color-swatch" style="background-color: #ff0000;" data-color="#ff0000"></div>
                                        <div class="color-swatch" style="background-color: #0000ff;" data-color="#0000ff"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="w-px h-5 bg-gray-300"></div>
                            <button data-command="bold" class="toolbar-btn font-bold">B</button>
                            <button data-command="italic" class="toolbar-btn italic">I</button>
                            <div class="w-px h-5 bg-gray-300"></div>
                            <button data-command="formatBlock" data-value="h2" class="toolbar-btn text-lg font-bold">H2</button>
                            <button data-command="formatBlock" data-value="h3" class="toolbar-btn text-base font-bold">H3</button>
                            <button data-command="formatBlock" data-value="h4" class="toolbar-btn text-sm font-bold">H4</button>
                            <div class="w-px h-5 bg-gray-300"></div>
                            <button data-command="formatBlock" data-value="blockquote" class="toolbar-btn text-gray-500 text-lg">“ ”</button>
                            <button data-command="insertCodeBlock" class="toolbar-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                                </svg>
                            </button>
                            <button data-command="insertHorizontalRule" class="toolbar-btn text-gray-500">-</button>
                        </div>
                        <div id="editor-content" contenteditable="true" class="flex-grow border border-gray-300 rounded-b-md p-2 overflow-y-auto editor-content"></div>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                        <button id="editor-delete-btn" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white rounded-md mb-2 sm:mb-0">삭제</button>
                        <div class="space-x-2">
                            <button id="editor-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md">취소</button>
                            <button id="editor-save-btn" class="px-4 py-2 bg-black text-white rounded-md">저장</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 5. 배너 이미지 선택 모달 -->
    <div id="banner-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl h-[70vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <div id="banner-tabs" class="flex space-x-4">
                    <button data-tab="upload" class="tab-btn font-bold border-b-2 border-black">업로드</button>
                    <button data-tab="unsplash" class="tab-btn text-gray-500">Unsplash</button>
                </div>
                <button id="banner-close-btn" class="text-gray-500 text-2xl">&times;</button>
            </div>
            <div class="p-4 flex-grow overflow-y-auto">
                <div id="upload-tab" class="tab-content">
                    <input type="file" id="banner-upload-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-black hover:file:bg-gray-100"/>
                    <p class="mt-2 text-xs text-gray-500">권장 비율: 16:9 (가로가 긴 이미지)</p>
                </div>
                <div id="unsplash-tab" class="tab-content hidden">
                    <div class="flex mb-4">
                        <input type="text" id="unsplash-search-input" class="flex-grow border border-gray-300 rounded-l-md p-2" placeholder="예: nature, coding...">
                        <button id="unsplash-search-btn" class="bg-black text-white px-4 rounded-r-md">검색</button>
                    </div>
                    <div id="unsplash-results" class="grid grid-cols-3 gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 알림 및 확인 모달 -->
    <div id="custom-alert" class="hidden fixed top-5 right-5 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <p id="custom-alert-message"></p>
    </div>
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-8 shadow-xl w-full max-w-sm">
            <h2 class="text-lg font-bold mb-2">게시물 삭제</h2>
            <p id="delete-confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-2">
                <button id="delete-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-md">취소</button>
                <button id="delete-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-md">삭제</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK 추가 -->
    <script type="module">
        // Firebase 버전 10 이상에서는 모듈 방식으로 import 합니다.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- Firebase 설정 ---
        const firebaseConfig = JSON.parse('__FIREBASE_CONFIG__');

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const postsCollection = collection(db, 'posts');

        // --- 중요! 관리자 계정 설정 ---
        // 여기에 관리자(본인)의 구글 계정 UID를 입력하세요.
        // UID는 처음 구글 계정으로 로그인 후 개발자 도구 콘솔에서 확인할 수 있습니다.
        const ADMIN_UID = "meuPpcdJbsaloI20dsb1fqSaKTm1"; 

        // --- 데이터 관리 ---
        let posts = []; 
        let currentEditingPostId = null;
        let isCreatingNewPost = false;
        let tempBannerUrl = null;
        let savedRange = null;

        // --- DOM 요소 ---
        const mainContainer = document.getElementById('main-container');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
        const adminControls = document.getElementById('admin-controls');
        const editorModal = document.getElementById('editor-modal');
        const editorPostList = document.getElementById('editor-post-list');
        const editorTitle = document.getElementById('editor-title');
        const editorDate = document.getElementById('editor-date');
        const editorPinToggle = document.getElementById('editor-pin-toggle');
        const editorToolbar = document.getElementById('editor-toolbar');
        const editorContent = document.getElementById('editor-content');
        const editorSaveBtn = document.getElementById('editor-save-btn');
        const editorDeleteBtn = document.getElementById('editor-delete-btn');
        const editorCloseBtn = document.getElementById('editor-close-btn');
        const editorCancelBtn = document.getElementById('editor-cancel-btn');
        const addNewPostBtn = document.getElementById('add-new-post-btn');
        const addBannerBtn = document.getElementById('add-banner-btn');
        const removeBannerBtn = document.getElementById('remove-banner-btn');
        const bannerModal = document.getElementById('banner-modal');
        const bannerCloseBtn = document.getElementById('banner-close-btn');
        const bannerTabs = document.getElementById('banner-tabs');
        const bannerUploadInput = document.getElementById('banner-upload-input');
        const unsplashSearchInput = document.getElementById('unsplash-search-input');
        const unsplashSearchBtn = document.getElementById('unsplash-search-btn');
        const unsplashResults = document.getElementById('unsplash-results');
        const customAlert = document.getElementById('custom-alert');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        const fontFamilySelect = document.getElementById('font-family-select');
        const colorPickerBtn = document.getElementById('color-picker-btn');
        const colorDropdown = document.getElementById('color-dropdown');
        const currentColorDisplay = document.getElementById('current-color-display');
        
        // --- Firebase 인증 상태 리스너 ---
        onAuthStateChanged(auth, user => {
            updateAdminUI(user);
            if (user && user.uid === ADMIN_UID) {
                console.log("관리자로 로그인했습니다:", user.displayName, user.uid);
            } else if (user) {
                console.log("일반 사용자로 로그인했습니다:", user.displayName, user.uid);
            } else {
                console.log("로그아웃 상태입니다.");
            }
        });

        // --- 구글 로그인/로그아웃 함수 ---
        const signInWithGoogle = () => {
            signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    showAlert(`${user.displayName}님, 환영합니다.`);
                    console.log("로그인 성공! UID:", user.uid);
                    console.log("이 UID를 복사하여 코드의 ADMIN_UID에 붙여넣으세요.");
                }).catch((error) => {
                    console.error("Google 로그인 실패:", error);
                    showAlert("로그인에 실패했습니다.", true);
                });
        };

        const signOutUser = () => {
            signOut(auth).then(() => {
                showAlert("로그아웃되었습니다.");
            }).catch((error) => {
                console.error("로그아웃 실패:", error);
                showAlert("로그아웃에 실패했습니다.", true);
            });
        };
        
        // --- 관리자 UI 업데이트 ---
        function updateAdminUI(user) {
            adminControls.innerHTML = ''; // 기존 버튼 초기화
            if (user && user.uid === ADMIN_UID) {
                // 관리자로 로그인한 경우
                const editorButton = document.createElement('button');
                editorButton.id = 'open-editor-btn';
                editorButton.className = 'text-white hover:text-gray-300 transition-colors mr-4';
                editorButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>`;
                editorButton.onclick = openEditor;
                
                const logoutButton = document.createElement('button');
                logoutButton.className = 'text-white hover:text-gray-300 transition-colors';
                logoutButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>`;
                logoutButton.onclick = signOutUser;
                
                adminControls.appendChild(editorButton);
                adminControls.appendChild(logoutButton);

            } else {
                // 로그아웃 상태이거나 일반 사용자인 경우
                const loginButton = document.createElement('button');
                loginButton.className = 'text-white hover:text-gray-300 transition-colors';
                loginButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>`;
                loginButton.onclick = signInWithGoogle;
                adminControls.appendChild(loginButton);
            }
        }


        // --- Firestore 데이터 리스너 ---
        function listenForPosts() {
            onSnapshot(postsCollection, (snapshot) => {
                const fetchedPosts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                posts = fetchedPosts.map(post => ({
                    ...post,
                    createdAt: post.createdAt?.toDate() || new Date(0),
                    updatedAt: post.updatedAt?.toDate()
                }));

                renderBlog();
                
                if (!editorModal.classList.contains('hidden')) {
                    populateEditorPostList();
                }

            }, (error) => {
                console.error("Firestore 데이터 수신 오류:", error);
                showAlert("데이터를 불러오는 데 실패했습니다.", true);
            });
        }
        
        // 페이지 로드 시 바로 데이터 로딩 시작
        listenForPosts();

        function renderBlog() {
            mainContainer.innerHTML = '';
            const aside = document.createElement('aside');
            aside.id = 'aside-menu';
            aside.className = "fixed top-0 left-0 w-4/5 max-w-sm md:w-1/3 lg:w-96 bg-gray-50 h-full overflow-y-auto p-6 transform -translate-x-full md:relative md:translate-x-0 md:h-auto z-40 flex-shrink-0";
            const ul = document.createElement('ul');
            ul.className = 'space-y-1';
            
            const sortedPosts = [...posts].sort((a, b) => {
                // 1. 고정 여부로 정렬 (고정된 글이 위로)
                if (a.isPinned !== b.isPinned) return b.isPinned - a.isPinned;
                // 2. 발행일로 정렬 (최신 글이 위로)
                return b.date.localeCompare(a.date);
            });

            if (sortedPosts.length > 0) {
                sortedPosts.forEach(post => {
                    const li = document.createElement('li');
                    const pinIconHTML = post.isPinned ? `<div class="w-5 text-center mr-2 flex-shrink-0 text-gray-400">📌</div>` : '<div class="w-5 mr-2 flex-shrink-0"></div>';
                    li.innerHTML = `<a href="#post-${post.id}" data-id="${post.id}" class="post-link flex items-center p-3 rounded-lg hover:bg-white hover:shadow-sm transition-all">${pinIconHTML}<span class="flex-1 truncate">${post.title}</span></a>`;
                    ul.appendChild(li);
                });
            }
            aside.appendChild(ul);

            const main = document.createElement('main');
            main.className = "w-full md:flex-grow h-full overflow-y-auto p-8 md:p-12";
            main.innerHTML = `<div id="post-content-wrapper" class="w-full"></div>`;
            mainContainer.appendChild(aside);
            mainContainer.appendChild(main);

            const firstPostToShow = sortedPosts[0];
            if (firstPostToShow) {
                renderPostContent(firstPostToShow.id);
                highlightActiveLink(firstPostToShow.id);
            } else {
                document.getElementById('post-content-wrapper').innerHTML = `<div class="text-center text-gray-500">게시물이 없습니다. 관리자 모드에서 새 글을 작성해보세요.</div>`;
            }
        }

        function renderPostContent(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            const wrapper = document.getElementById('post-content-wrapper');
            if(wrapper) {
                const bannerHTML = post.bannerUrl ? `<img src="${post.bannerUrl}" alt="Banner Image" class="banner-image mb-8 rounded-lg">` : '';
                const dividerHTML = `<hr class="my-6 border-gray-200">`;
                const fontSizeStyle = `font-size: ${post.fontSize || '18px'};`; // 저장된 폰트 크기 적용 (기본값 18px)
                wrapper.innerHTML = `<article class="max-w-3xl w-full mx-auto">${bannerHTML}<h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">${post.title}</h2><p class="text-gray-500 mb-6">${post.date}</p>${dividerHTML}<div class="content-body leading-relaxed text-gray-700" style="${fontSizeStyle}">${post.content}</div></article>`;
            }
        }
        
        function highlightActiveLink(postId) {
            document.querySelectorAll('.post-link').forEach(link => {
                const isMatch = link.dataset.id === postId;
                link.classList.toggle('bg-white', isMatch);
                link.classList.toggle('font-semibold', isMatch);
                link.classList.toggle('text-gray-900', isMatch);
                link.classList.toggle('shadow-sm', isMatch);
            });
        }

        mainContainer.addEventListener('click', (e) => {
            const link = e.target.closest('.post-link');
            if (link) {
                e.preventDefault();
                const postId = link.dataset.id;
                renderPostContent(postId);
                highlightActiveLink(postId);
                if (window.innerWidth < 768) {
                    toggleMobileMenu(false);
                }
            }
        });

        function showAlert(message, isError = false) {
            customAlertMessage.textContent = message;
            customAlert.classList.toggle('bg-red-500', isError);
            customAlert.classList.toggle('bg-green-500', !isError);
            customAlert.classList.remove('hidden');
            setTimeout(() => customAlert.classList.add('hidden'), 3000);
        }
        
        function toggleMobileMenu(show) {
            const asideMenu = document.getElementById('aside-menu');
            if (asideMenu) {
                if (show) {
                    mobileMenuOverlay.classList.remove('hidden');
                    asideMenu.classList.remove('-translate-x-full');
                } else {
                    mobileMenuOverlay.classList.add('hidden');
                    asideMenu.classList.add('-translate-x-full');
                }
            }
        }
        mobileMenuBtn.addEventListener('click', () => toggleMobileMenu(true));
        mobileMenuOverlay.addEventListener('click', () => toggleMobileMenu(false));

        function openEditor() {
            populateEditorPostList();
            editorModal.classList.remove('hidden');
            const sortedPosts = [...posts].sort((a, b) => {
                if (a.isPinned !== b.isPinned) return b.isPinned - a.isPinned;
                return b.date.localeCompare(a.date);
            });

            if (sortedPosts.length > 0) {
                loadPostInEditor(sortedPosts[0].id);
            } else {
                startNewPost();
            }
        }

        function closeEditor() {
            editorModal.classList.add('hidden');
            currentEditingPostId = null;
            isCreatingNewPost = false;
        }
        editorCloseBtn.addEventListener('click', closeEditor);
        editorCancelBtn.addEventListener('click', closeEditor);

        function populateEditorPostList() {
            editorPostList.innerHTML = '';
            const ul = document.createElement('ul');
            ul.className = 'space-y-1';
            const sortedPosts = [...posts].sort((a, b) => {
                if (a.isPinned !== b.isPinned) return b.isPinned - a.isPinned;
                return b.date.localeCompare(a.date);
            });
            sortedPosts.forEach(post => {
                const li = document.createElement('li');
                li.innerHTML = `<a href="#" data-id="${post.id}" class="editor-post-link block p-2 rounded-md hover:bg-gray-200 truncate">${post.title}</a>`;
                ul.appendChild(li);
            });
            editorPostList.appendChild(ul);
            
            if (currentEditingPostId) {
                 document.querySelectorAll('.editor-post-link').forEach(link => {
                    link.classList.toggle('bg-gray-300', link.dataset.id == currentEditingPostId);
                    link.classList.toggle('font-semibold', link.dataset.id == currentEditingPostId);
                });
            }
        }
        
        editorPostList.addEventListener('click', (e) => {
            const link = e.target.closest('.editor-post-link');
            if (link) {
                e.preventDefault();
                const postId = link.dataset.id;
                loadPostInEditor(postId);
            }
        });

        function updateBannerButtons() {
            removeBannerBtn.disabled = !tempBannerUrl;
        }

        function loadPostInEditor(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;
            isCreatingNewPost = false;
            editorDeleteBtn.disabled = false;
            currentEditingPostId = postId;
            tempBannerUrl = post.bannerUrl;
            editorTitle.value = post.title;
            editorDate.value = post.date;
            editorPinToggle.checked = post.isPinned;
            editorContent.innerHTML = post.content;
            editorSaveBtn.textContent = "수정 완료";
            updateBannerButtons();
            editorContent.style.fontSize = post.fontSize || '18px'; // 저장된 폰트 크기 적용
            updateToolbarState();
            
            document.querySelectorAll('.editor-post-link').forEach(link => {
                link.classList.toggle('bg-gray-300', link.dataset.id === postId);
                link.classList.toggle('font-semibold', link.dataset.id === postId);
            });
        }

        addNewPostBtn.addEventListener('click', startNewPost);

        function startNewPost() {
            isCreatingNewPost = true;
            editorDeleteBtn.disabled = true;
            currentEditingPostId = null;
            tempBannerUrl = null;
            editorTitle.value = "새로운 게시물";
            
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            editorDate.value = `${year}-${month}-${day}`;

            editorPinToggle.checked = false;
            editorContent.innerHTML = "<p>여기에 내용을 입력하세요.</p>";
            editorSaveBtn.textContent = "게시물 발행";
            updateBannerButtons();
            editorContent.style.fontSize = '18px'; // 새 글 작성 시 기본값으로 리셋
            updateToolbarState();
            
            document.querySelectorAll('.editor-post-link').forEach(link => {
                link.classList.remove('bg-gray-300', 'font-semibold');
            });
            editorTitle.focus();
        }
        
        // --- 툴바 로직 ---

        editorToolbar.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.command) {
                e.preventDefault();
                const command = button.dataset.command;
                const value = button.dataset.value || null;
                
                if (command === 'setGlobalFontSize') {
                    setGlobalFontSize(value);
                } else if (command === 'insertCodeBlock') {
                    insertCodeBlock();
                }
                else {
                    applyStyle(command, value);
                }
            }
        });

        fontFamilySelect.addEventListener('change', (e) => applyStyle('fontFamily', e.target.value));
        
        // --- 색상 선택기 로직 ---
        colorPickerBtn.addEventListener('click', () => {
            colorDropdown.classList.toggle('hidden');
        });

        colorDropdown.addEventListener('click', (e) => {
            if (e.target.classList.contains('color-swatch')) {
                const color = e.target.dataset.color;
                applyStyle('foreColor', color);
                currentColorDisplay.style.backgroundColor = color;
                colorDropdown.classList.add('hidden');
            }
        });

        document.addEventListener('click', (e) => {
            if (!colorPickerBtn.contains(e.target) && !colorDropdown.contains(e.target)) {
                colorDropdown.classList.add('hidden');
            }
        });


        editorContent.addEventListener('blur', (e) => {
            if (editorToolbar.contains(e.relatedTarget)) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    savedRange = selection.getRangeAt(0).cloneRange();
                }
            } else {
                savedRange = null;
            }
        });

        function setGlobalFontSize(size) {
            // 에디터 내의 모든 요소에서 기존 font-size 스타일을 제거합니다.
            const allElements = editorContent.querySelectorAll('*');
            allElements.forEach(el => {
                if (el.style.fontSize) {
                    el.style.removeProperty('font-size');
                }
                if (el.getAttribute('style') === '') {
                    el.removeAttribute('style');
                }
            });
            // 에디터 컨테이너에만 font-size를 적용합니다.
            editorContent.style.fontSize = size;
            updateToolbarState();
        }

        function insertCodeBlock() {
            const codeBlockHTML = `
                <div class="code-block-wrapper" contenteditable="false">
                    <button class="copy-code-btn">복사</button>
                    <pre contenteditable="true" spellcheck="false">코드를 여기에 붙여넣으세요.</pre>
                </div>
            `;
            // 현재 커서 위치에 코드 블록을 삽입합니다.
            document.execCommand('insertHTML', false, codeBlockHTML + '<p><br></p>');
        }

        function applyStyle(command, value = null) {
            editorContent.focus();
            if (savedRange) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedRange);
            }

            switch (command) {
                case 'bold':
                case 'italic':
                case 'insertHorizontalRule':
                case 'foreColor':
                    document.execCommand(command, false, value);
                    break;
                
                case 'formatBlock':
                    let parentNode = window.getSelection().anchorNode;
                    if (parentNode && parentNode.nodeType !== 1) parentNode = parentNode.parentNode;
                    const effectiveNode = parentNode.closest('h2, h3, h4, blockquote');
                    if (effectiveNode && effectiveNode.tagName.toLowerCase() === value) {
                        document.execCommand('formatBlock', false, 'p');
                    } else {
                        document.execCommand(command, false, value);
                    }
                    break;

                case 'fontFamily':
                    wrapWithSpan({ 'font-family': value });
                    break;
            }

            savedRange = null;
            updateToolbarState();
        }

        function unwrapNode(node) {
            const parent = node.parentNode;
            if (!parent) return;
            while (node.firstChild) {
                parent.insertBefore(node.firstChild, node);
            }
            parent.removeChild(node);
        }

        function cleanNodeRecursively(node, styleProperty) {
            if (node.nodeType !== 1) return;
            const children = Array.from(node.childNodes);
            for (const child of children) {
                cleanNodeRecursively(child, styleProperty);
            }
            if (node.tagName === 'SPAN' && node.style[styleProperty]) {
                node.style[styleProperty] = '';
                if (!node.style.cssText) {
                    unwrapNode(node);
                }
            }
        }

        function wrapWithSpan(styles) {
            const selection = window.getSelection();
            if (!selection.rangeCount || selection.isCollapsed) return;
            const range = selection.getRangeAt(0);
            const styleProperty = Object.keys(styles)[0];
            const selectedFragment = range.extractContents();
            cleanNodeRecursively(selectedFragment, styleProperty);
            const span = document.createElement('span');
            Object.assign(span.style, styles);
            span.appendChild(selectedFragment);
            range.insertNode(span);
            selection.removeAllRanges();
            const newRange = document.createRange();
            newRange.selectNodeContents(span);
            selection.addRange(newRange);
        }

        document.addEventListener('selectionchange', () => {
            if (document.activeElement === editorContent) {
                 updateToolbarState();
            }
        });

        function updateToolbarState() {
            ['bold', 'italic'].forEach(command => {
                const button = editorToolbar.querySelector(`[data-command="${command}"]`);
                if (button) button.classList.toggle('active', document.queryCommandState(command));
            });
            let parentNode = window.getSelection().anchorNode;
            if (parentNode && parentNode.nodeType !== 1) parentNode = parentNode.parentNode;
            if (parentNode) {
                editorToolbar.querySelectorAll('[data-command="formatBlock"]').forEach(button => {
                    const tag = button.dataset.value;
                    button.classList.toggle('active', !!parentNode.closest(tag));
                });
            }
            
            const currentSize = editorContent.style.fontSize || '18px';
            editorToolbar.querySelectorAll('[data-command="setGlobalFontSize"]').forEach(button => {
                button.classList.toggle('active', button.dataset.value === currentSize);
            });
        }

        // --- Firestore 데이터 수정/삭제 ---
        editorDeleteBtn.addEventListener('click', () => {
            if (isCreatingNewPost || currentEditingPostId === null) return;
            const postToDelete = posts.find(p => p.id === currentEditingPostId);
            if (postToDelete) {
                deleteConfirmMessage.textContent = `'${postToDelete.title}' 게시물을 정말 삭제하시겠습니까?`;
                deleteConfirmModal.classList.remove('hidden');
            }
        });

        deleteCancelBtn.addEventListener('click', () => deleteConfirmModal.classList.add('hidden'));
        
        deleteConfirmBtn.addEventListener('click', async () => {
            if (currentEditingPostId === null) return;
            try {
                await deleteDoc(doc(db, "posts", currentEditingPostId));
                deleteConfirmModal.classList.add('hidden');
                showAlert("게시물이 삭제되었습니다.");
                startNewPost();
                renderBlog();
            } catch (error) {
                console.error("삭제 오류: ", error);
                showAlert("게시물 삭제에 실패했습니다.", true);
            }
        });

        editorSaveBtn.addEventListener('click', async () => {
            try {
                 // 저장하기 전에 내부 폰트 스타일 정리
                const allElements = editorContent.querySelectorAll('*');
                allElements.forEach(el => {
                    if (el.style.fontSize) {
                        el.style.removeProperty('font-size');
                    }
                    if (el.getAttribute('style') === '') {
                        el.removeAttribute('style');
                    }
                });

                const postData = {
                    title: editorTitle.value,
                    date: editorDate.value,
                    content: editorContent.innerHTML,
                    isPinned: editorPinToggle.checked,
                    bannerUrl: tempBannerUrl,
                    fontSize: editorContent.style.fontSize || '18px' // 폰트 크기 저장
                };

                if (isCreatingNewPost) {
                    postData.createdAt = serverTimestamp();
                    const docRef = await addDoc(postsCollection, postData);
                    showAlert("새 게시물이 발행되었습니다.");
                    isCreatingNewPost = false;
                    currentEditingPostId = docRef.id;
                    editorSaveBtn.textContent = "수정 완료";
                    editorDeleteBtn.disabled = false;
                } else {
                    if (currentEditingPostId === null) return;
                    postData.updatedAt = serverTimestamp();
                    const postRef = doc(db, "posts", currentEditingPostId);
                    await updateDoc(postRef, postData);
                    showAlert("게시물이 성공적으로 수정되었습니다.");
                }
                renderBlog();
            } catch (error) {
                console.error("저장 오류: ", error);
                showAlert("저장에 실패했습니다.", true);
            }
        });

        // --- 배너 모달 로직 ---
        addBannerBtn.addEventListener('click', () => bannerModal.classList.remove('hidden'));
        removeBannerBtn.addEventListener('click', () => {
            tempBannerUrl = null;
            showAlert('배너가 삭제되었습니다.');
            updateBannerButtons();
        });
        bannerCloseBtn.addEventListener('click', () => bannerModal.classList.add('hidden'));
        
        bannerTabs.addEventListener('click', (e) => {
            if(e.target.classList.contains('tab-btn')) {
                const tabName = e.target.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('font-bold', btn.dataset.tab === tabName);
                    btn.classList.toggle('border-b-2', btn.dataset.tab === tabName);
                    btn.classList.toggle('border-black', btn.dataset.tab === tabName);
                    btn.classList.toggle('text-gray-500', btn.dataset.tab !== tabName);
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== `${tabName}-tab`);
                });
            }
        });

        bannerUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    tempBannerUrl = event.target.result;
                    showAlert('배너 이미지가 설정되었습니다.');
                    bannerModal.classList.add('hidden');
                    updateBannerButtons();
                };
                reader.readAsDataURL(file);
            }
        });

        async function searchUnsplash(query) {
            const UNSPLASH_ACCESS_KEY = '__UNSPLASH_ACCESS_KEY__';
            unsplashResults.innerHTML = '';
            const loading = document.createElement('p');
            loading.className = 'text-gray-500';
            loading.textContent = '이미지를 불러오는 중...';
            unsplashResults.appendChild(loading);
            
            try {
                const response = await fetch(`https://api.unsplash.com/search/photos?query=${query}&per_page=6&client_id=${UNSPLASH_ACCESS_KEY}`);
                
                if (!response.ok) {
                    if(response.status === 401) {
                         throw new Error(`API 인증 오류: Unsplash Access Key가 유효한지 확인하세요.`);
                    }
                    throw new Error(`API Error: ${response.statusText}`);
                }
                const data = await response.json();
                loading.remove();

                if (data.results.length === 0) {
                    unsplashResults.innerHTML = '<p class="text-gray-500">검색 결과가 없습니다.</p>';
                    return;
                }
                
                data.results.forEach(photo => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'cursor-pointer aspect-w-4 aspect-h-3';
                    imgContainer.innerHTML = `<img src="${photo.urls.small}" class="w-full h-full object-cover rounded-md">`;
                    imgContainer.onclick = () => {
                        tempBannerUrl = photo.urls.regular;
                        showAlert('배너 이미지가 설정되었습니다.');
                        bannerModal.classList.add('hidden');
                        updateBannerButtons();
                    };
                    unsplashResults.appendChild(imgContainer);
                });

            } catch (error) {
                console.error("Unsplash API Error:", error);
                showAlert("저장에 실패했습니다.", true);
            }
        }
        unsplashSearchBtn.addEventListener('click', () => searchUnsplash(unsplashSearchInput.value));
        unsplashSearchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') searchUnsplash(e.target.value);
        });

        // 코드 복사 이벤트 리스너 (이벤트 위임 사용)
        document.body.addEventListener('click', (e) => {
            if (e.target.classList.contains('copy-code-btn')) {
                const wrapper = e.target.closest('.code-block-wrapper');
                const codeToCopy = wrapper.querySelector('pre').innerText;
                
                // 임시 textarea를 사용하여 복사
                const textarea = document.createElement('textarea');
                textarea.value = codeToCopy;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                e.target.textContent = '복사 완료!';
                setTimeout(() => {
                    e.target.textContent = '복사';
                }, 2000);
            }
        });
        
    </script>
</body>
</html>
